
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>1.4. Loopy Belief Propagation &#8212; GTSAM by Example</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="1.5. Clustered Belief Propagation" href="GaussianMRFExample_cbp.html" />
    <link rel="prev" title="1.3. Gaussian Markov Random Fields" href="GaussianMRFExample.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">GTSAM by Example</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   GTSAM by Example
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="gaussian.html">
   1. Gaussian Inference
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="KalmanSmootherExample.html">
     1.1. Kalman Smoother
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="KalmanSmootherExample2.html">
     1.2. Advanced Kalman Smoothing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="GaussianMRFExample.html">
     1.3. Gaussian Markov Random Fields
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     1.4. Loopy Belief Propagation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="GaussianMRFExample_cbp.html">
     1.5. Clustered Belief Propagation
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="slam.html">
   2. SLAM
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="Pose2SLAMExample.html">
     2.1. Pose2 SLAM
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Pose2ISAM2Example.html">
     2.2. Pose2 iSAM
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Pose2SLAMExample_g2o.html">
     2.3. Pose2 SLAM with g2o Files
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="PlanarSLAMExample.html">
     2.4. Planar SLAM
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="advanced.html">
   3. Advanced Inference
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="PlanarSLAMExample_sampling.html">
     3.1. Sampling from the posterior
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="PlanarSLAMExample_lbp.html">
     3.2. Loopy Belief Propagation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="PlanarSLAMExample_gvi.html">
     3.3. Variational Bayes Inference
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="sfm.html">
   4. Structure from Motion
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="SFMExample.html">
     4.1. Structure from Motion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="SFMExample_bal.html">
     4.2. SFM with BAL Files
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="StereoVOExample_large.html">
     4.3. Stereo Visual Odometry
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/GaussianMRFExample_lbp.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/gtbook/gtsam-examples"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/gtbook/gtsam-examples/issues/new?title=Issue%20on%20page%20%2FGaussianMRFExample_lbp.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/gtbook/gtsam-examples/main?urlpath=tree/GaussianMRFExample_lbp.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-small-image-mrf">
   1.4.1. A Small “Image” MRF
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   1.4.2. Loopy Belief Propagation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#gibbs-sampling">
   1.4.3. Gibbs Sampling
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#elimination-vs-message-passing">
   1.4.4. Elimination vs. Message Passing
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Loopy Belief Propagation</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-small-image-mrf">
   1.4.1. A Small “Image” MRF
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   1.4.2. Loopy Belief Propagation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#gibbs-sampling">
   1.4.3. Gibbs Sampling
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#elimination-vs-message-passing">
   1.4.4. Elimination vs. Message Passing
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <p><a href="https://colab.research.google.com/github/gtbook/gtsam-examples/blob/main/GaussianMRFExample_lbp.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
<div class="tex2jax_ignore mathjax_ignore section" id="loopy-belief-propagation">
<h1><span class="section-number">1.4. </span>Loopy Belief Propagation<a class="headerlink" href="#loopy-belief-propagation" title="Permalink to this headline">¶</a></h1>
<p>We start from the same “image MRF, with unary and pairwise Gaussian factors. We then implement loopy belief propagation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">pip</span> -q install gtbook  # also installs latest gtsam pre-release
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Note: you may need to restart the kernel to use updated packages.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">from</span> <span class="nn">plotly.subplots</span> <span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">google.colab</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">plotly.io</span> <span class="k">as</span> <span class="nn">pio</span>
    <span class="n">pio</span><span class="o">.</span><span class="n">renderers</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="s2">&quot;png&quot;</span>

<span class="kn">import</span> <span class="nn">gtsam</span>
<span class="kn">from</span> <span class="nn">gtbook.display</span> <span class="kn">import</span> <span class="n">show</span>
<span class="kn">from</span> <span class="nn">gtsam</span> <span class="kn">import</span> <span class="n">noiseModel</span>

<span class="k">def</span> <span class="nf">square</span><span class="p">(</span><span class="n">vv</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">gtsam</span><span class="o">.</span><span class="n">VectorValues</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key_list</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">vv</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="a-small-image-mrf">
<h2><span class="section-number">1.4.1. </span>A Small “Image” MRF<a class="headerlink" href="#a-small-image-mrf" title="Permalink to this headline">¶</a></h2>
<p>All the code to create the small image “MRF” in one cell:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>  <span class="c1"># try playing with this</span>
<span class="n">row_symbols</span> <span class="o">=</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">)]</span>
<span class="n">keys</span> <span class="o">=</span> <span class="p">{(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span> <span class="n">gtsam</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="n">row_symbols</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="n">col</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
       <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)}</span>

<span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">data_model</span> <span class="o">=</span> <span class="n">noiseModel</span><span class="o">.</span><span class="n">Isotropic</span><span class="o">.</span><span class="n">Sigmas</span><span class="p">([</span><span class="n">sigma</span><span class="p">])</span>

<span class="n">smoothness_sigma</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">smoothness_model</span> <span class="o">=</span> <span class="n">noiseModel</span><span class="o">.</span><span class="n">Isotropic</span><span class="o">.</span><span class="n">Sigmas</span><span class="p">([</span><span class="n">smoothness_sigma</span><span class="p">])</span>

<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">gtsam</span><span class="o">.</span><span class="n">GaussianFactorGraph</span><span class="p">()</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="c1"># add data terms:</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">)]</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">]),</span> <span class="n">data_model</span><span class="p">)</span>
        <span class="c1"># add smoothness terms:</span>
        <span class="k">if</span> <span class="n">col</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">j1</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="o">-</span><span class="n">I</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">smoothness_model</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">j2</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[(</span><span class="n">row</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">col</span><span class="p">)]</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="o">-</span><span class="n">I</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">smoothness_model</span><span class="p">)</span>

<span class="n">position_hints</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span><span class="nb">float</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row_symbols</span><span class="p">)}</span>
<span class="n">show</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">binary_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hints</span><span class="o">=</span><span class="n">position_hints</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/GaussianMRFExample_lbp_6_0.svg" src="_images/GaussianMRFExample_lbp_6_0.svg" /></div>
</div>
<p>And the data image is shown here:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">zmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/GaussianMRFExample_lbp_8_0.png" src="_images/GaussianMRFExample_lbp_8_0.png" />
</div>
</div>
</div>
<div class="section" id="id1">
<h2><span class="section-number">1.4.2. </span>Loopy Belief Propagation<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>We initialize a set of individual <em>Gaussian</em> factors <span class="math notranslate nohighlight">\(q(x_j)\)</span> or <em>beliefs</em>, one for each variable. LBP is a fixed point algorithm to minimize the KL <span class="math notranslate nohighlight">\(D_\text{KL}(p||q)\)</span> divergence between the true posterior <span class="math notranslate nohighlight">\(p(X|Z)\)</span> and the variational approximation</p>
<div class="math notranslate nohighlight">
\[
q(X) = \prod_j q(x_j)
\]</div>
<p>We repeatedly:</p>
<ul class="simple">
<li><p>pick a variable <span class="math notranslate nohighlight">\(x_j\)</span> at random;</p></li>
<li><p>consider the Markov blanket of <span class="math notranslate nohighlight">\(x_j\)</span>, the factor graph fragment <span class="math notranslate nohighlight">\(\phi(x_j, X_j)\)</span> where <span class="math notranslate nohighlight">\(X_j\)</span> is the separator;</p></li>
<li><p>augment the factor graph fragment with (downdated) beliefs on all <span class="math notranslate nohighlight">\(x_k\in X_j\)</span>, <em>except</em> <span class="math notranslate nohighlight">\(q(x_j)\)</span>;</p></li>
<li><p>eliminate the separator <span class="math notranslate nohighlight">\(X_j\)</span> by factorizing this graph as <span class="math notranslate nohighlight">\(p(X_j|x_j)q'(x_j)\)</span>;</p></li>
<li><p>assign <span class="math notranslate nohighlight">\(q(x_j) \leftarrow q'(x_j)\)</span> to be the new belief on <span class="math notranslate nohighlight">\(x_j\)</span>.</p></li>
</ul>
<p>We first cache all Markov blankets:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">local_factor_indices</span> <span class="o">=</span>  <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">markov_blankets</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">gtsam</span><span class="o">.</span><span class="n">GaussianFactorGraph</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">size</span><span class="p">()):</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">factor</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">local_factor_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">markov_blankets</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here are the Markov blanket for <span class="math notranslate nohighlight">\(x_{a1}\)</span> and <span class="math notranslate nohighlight">\(x_{b2}\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show</span><span class="p">(</span><span class="n">markov_blankets</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">binary_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hints</span><span class="o">=</span><span class="n">position_hints</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/GaussianMRFExample_lbp_12_0.svg" src="_images/GaussianMRFExample_lbp_12_0.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show</span><span class="p">(</span><span class="n">markov_blankets</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">binary_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hints</span><span class="o">=</span><span class="n">position_hints</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/GaussianMRFExample_lbp_13_0.svg" src="_images/GaussianMRFExample_lbp_13_0.svg" /></div>
</div>
<p>We store the belief <span class="math notranslate nohighlight">\(q(x)\)</span> as <code class="docutils literal notranslate"><span class="pre">gtsam.GaussianDensity</span></code> instances. The entire LPB code is then:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">lbp</span><span class="p">(</span><span class="n">x0</span><span class="p">:</span> <span class="n">gtsam</span><span class="o">.</span><span class="n">VectorValues</span><span class="p">,</span> <span class="n">hook</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">initial_sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform loopy belief propagation with initial estimate x.&quot;&quot;&quot;</span>
    <span class="n">key_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keys</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Initialize belief</span>
    <span class="n">q</span> <span class="o">=</span> <span class="p">{</span><span class="n">j</span><span class="p">:</span> <span class="n">gtsam</span><span class="o">.</span><span class="n">GaussianDensity</span><span class="o">.</span><span class="n">FromMeanAndStddev</span><span class="p">(</span>
        <span class="n">j</span><span class="p">,</span> <span class="n">x0</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">initial_sigma</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">key_list</span><span class="p">}</span>

    <span class="c1"># Initialize messages from factor i to variable j</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">{</span><span class="n">j</span><span class="p">:</span> <span class="n">gtsam</span><span class="o">.</span><span class="n">HessianFactor</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">key_list</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">size</span><span class="p">())}</span>

    <span class="k">def</span> <span class="nf">get_message</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get message from factor to j&quot;&quot;&quot;</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">factor</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">factor</span>
        <span class="n">factor_graph</span><span class="p">,</span> <span class="n">ordering</span> <span class="o">=</span> <span class="n">gtsam</span><span class="o">.</span><span class="n">GaussianFactorGraph</span><span class="p">(),</span> <span class="n">gtsam</span><span class="o">.</span><span class="n">Ordering</span><span class="p">()</span>
        <span class="n">factor_graph</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">factor</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="n">j</span><span class="p">]:</span>
            <span class="n">ordering</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">factor_graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">factor_graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">messages</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">negate</span><span class="p">())</span>  <span class="c1"># downdates!</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">remaining</span> <span class="o">=</span> <span class="n">factor_graph</span><span class="o">.</span><span class="n">eliminatePartialSequential</span><span class="p">(</span><span class="n">ordering</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">remaining</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">j</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Augment Markov blanket and eliminate to x_j&quot;&quot;&quot;</span>
        <span class="c1"># Calculate &quot;messages&quot; from all factors in Markov blanket:</span>
        <span class="n">augmented_graph</span> <span class="o">=</span> <span class="n">gtsam</span><span class="o">.</span><span class="n">GaussianFactorGraph</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">local_factor_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
            <span class="n">messages</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_message</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
            <span class="n">augmented_graph</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">messages</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>

        <span class="c1"># Eliminate with x_j eliminated last:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="n">gtsam</span><span class="o">.</span><span class="n">Ordering</span><span class="o">.</span><span class="n">ColamdConstrainedLastGaussianFactorGraph</span><span class="p">(</span>
            <span class="n">augmented_graph</span><span class="p">,</span> <span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">gbn</span> <span class="o">=</span> <span class="n">augmented_graph</span><span class="o">.</span><span class="n">eliminateSequential</span><span class="p">(</span><span class="n">ordering</span><span class="p">)</span>
        <span class="n">q</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">gbn</span><span class="o">.</span><span class="n">back</span><span class="p">()</span>  <span class="c1"># new belief!</span>

    <span class="n">hook</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># choose a variable whose belief to update</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">key_list</span><span class="p">[</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">N</span><span class="p">)]</span>
        <span class="n">update</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">hook</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span>
</pre></div>
</div>
</div>
</div>
<p>We initialize to the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">initial</span> <span class="o">=</span> <span class="n">gtsam</span><span class="o">.</span><span class="n">VectorValues</span><span class="p">()</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">)]</span>
        <span class="n">initial</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calculate_mean</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate mean of each q[j]&quot;&quot;&quot;</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">gtsam</span><span class="o">.</span><span class="n">VectorValues</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">qj</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">mean</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mean</span>

<span class="k">def</span> <span class="nf">print_hook</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">calculate_mean</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">it</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">it</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">it</span><span class="si">=}</span><span class="s2">, initial error is </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">it</span><span class="si">=}</span><span class="s2">, updated </span><span class="si">{</span><span class="n">gtsam</span><span class="o">.</span><span class="n">DefaultKeyFormatter</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="si">}</span><span class="s2">, error now </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">q</span> <span class="o">=</span> <span class="n">lbp</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">print_hook</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>it=0, initial error is 12.126645986142575
it=10, updated a2, error now 9.113900486816643
it=20, updated b2, error now 8.524714446372975
it=30, updated b2, error now 4.881997061292955
it=40, updated b4, error now 3.3732148265768735
it=50, updated c2, error now 3.191536790242739
it=60, updated c1, error now 3.147855313649847
it=70, updated b2, error now 3.1464772839425956
it=80, updated c1, error now 3.1456805402875254
it=90, updated c2, error now 3.14452888223852
it=100, updated a2, error now 3.1442569269735574
it=110, updated c1, error now 3.1441842205421846
it=120, updated a2, error now 3.144144868279104
it=130, updated b4, error now 3.1441466837532785
it=140, updated b2, error now 3.1441423296105064
it=150, updated a1, error now 3.144001745678235
</pre></div>
</div>
</div>
</div>
<p>We compare the mean with the exact mean and see that LBP converges to the correct mean value:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">calculate_mean</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="n">stddev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">M</span><span class="o">*</span><span class="n">N</span><span class="p">,))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">qj</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">information</span> <span class="o">=</span> <span class="n">qj</span><span class="o">.</span><span class="n">information</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="n">stddev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">information</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gtsam</span><span class="o">.</span><span class="n">DefaultKeyFormatter</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">stddev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a1 -0.16 +/- 0.32
a2 -0.22 +/- 0.28
a3 0.09 +/- 0.28
a4 0.21 +/- 0.32
b1 -0.41 +/- 0.29
b2 -0.30 +/- 0.25
b3 0.00 +/- 0.25
b4 0.06 +/- 0.29
c1 -0.21 +/- 0.32
c2 -0.21 +/- 0.28
c3 0.11 +/- 0.28
c4 0.18 +/- 0.32
</pre></div>
</div>
</div>
</div>
<p>The exact mean is calculated below, as well as the exact standard deviations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">key_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keys</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="n">bayes_tree</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">eliminateMultifrontal</span><span class="p">()</span>
<span class="n">exact_mean</span> <span class="o">=</span> <span class="n">bayes_tree</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
<span class="n">exact_stddev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">M</span><span class="o">*</span><span class="n">N</span><span class="p">,))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">key_list</span><span class="p">):</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">bayes_tree</span><span class="o">.</span><span class="n">marginalCovariance</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="n">exact_stddev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gtsam</span><span class="o">.</span><span class="n">DefaultKeyFormatter</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">exact_mean</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">exact_stddev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;direct solver error: </span><span class="si">{</span><span class="n">graph</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">exact_mean</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a1 -0.16 +/- 0.33
a2 -0.22 +/- 0.29
a3 0.09 +/- 0.29
a4 0.21 +/- 0.33
b1 -0.41 +/- 0.29
b2 -0.30 +/- 0.26
b3 0.00 +/- 0.26
b4 0.06 +/- 0.29
c1 -0.21 +/- 0.33
c2 -0.21 +/- 0.29
c3 0.11 +/- 0.29
c4 0.18 +/- 0.33
direct solver error: 3.1439968801524447
</pre></div>
</div>
</div>
</div>
<p>As you can see, the LBP approximation is a bit over-confident. This is a well known property of LBP. we show the effect side by side again below, with LBP <span class="math notranslate nohighlight">\(\mu/\sigma\)</span> in the top row, and exact <span class="math notranslate nohighlight">\(\mu/\sigma\)</span> in the bottom row.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">)),</span> <span class="n">zmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">exact_mean</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">)),</span> <span class="n">zmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">stddev</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">)),</span> <span class="n">zmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="mf">0.35</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">exact_stddev</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">)),</span> <span class="n">zmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="mf">0.35</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/GaussianMRFExample_lbp_24_0.png" src="_images/GaussianMRFExample_lbp_24_0.png" />
</div>
</div>
</div>
<div class="section" id="gibbs-sampling">
<h2><span class="section-number">1.4.3. </span>Gibbs Sampling<a class="headerlink" href="#gibbs-sampling" title="Permalink to this headline">¶</a></h2>
<p>Gibbs sampling is a variant of Markov Chain Monte Carlo sampling that always accepts any proposal.</p>
<p>We repeatedly:</p>
<ul class="simple">
<li><p>pick a variable <span class="math notranslate nohighlight">\(x_j\)</span> at random;</p></li>
<li><p>consider the Markov blanket of <span class="math notranslate nohighlight">\(x_j\)</span>, the factor graph fragment <span class="math notranslate nohighlight">\(\phi(x_j, X_j)\)</span> where <span class="math notranslate nohighlight">\(X_j\)</span> is the separator;</p></li>
<li><p>eliminate the variable <span class="math notranslate nohighlight">\(x_j\)</span> by factorizing <span class="math notranslate nohighlight">\(\phi(x_j, X_j) = p(x_j|X_j)\phi(X_j)\)</span>;</p></li>
<li><p>sample <span class="math notranslate nohighlight">\(x_j\)</span> <span class="math notranslate nohighlight">\(\phi(x_j, X_j)\)</span>.</p></li>
</ul>
<p>We first compute all conditionals <span class="math notranslate nohighlight">\(p(x_j|X_j)\)</span>, which we can do <em>in advance</em>, as well as the inverse square root covariances <span class="math notranslate nohighlight">\(R_j^{-1}\)</span>, which we need for sampling. An advantage of working in square-root information form (like the entirety of GTSAM) is that less computation is needed <em>and</em> it is numerically more stable:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">conditionals</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">invR</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">key_list</span><span class="p">:</span>
    <span class="n">local_graph</span> <span class="o">=</span> <span class="n">markov_blankets</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
    <span class="c1"># Eliminate just x_j:</span>
    <span class="n">ordering</span> <span class="o">=</span> <span class="n">gtsam</span><span class="o">.</span><span class="n">Ordering</span><span class="p">()</span>
    <span class="n">ordering</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="n">gbn</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">local_graph</span><span class="o">.</span><span class="n">eliminatePartialSequential</span><span class="p">(</span><span class="n">ordering</span><span class="p">)</span>
    <span class="n">conditionals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">gbn</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">invR</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">conditionals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">R</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>The conditional is parameterized by <span class="math notranslate nohighlight">\(R\)</span>, <span class="math notranslate nohighlight">\(S\)</span> and <span class="math notranslate nohighlight">\(d\)</span> as follows:</p>
<div class="math notranslate nohighlight">
\[
p(x_j|X_j) \propto \exp \{-0.5 \|R x_j + S X_j - d\|^2\}
\]</div>
<p>A Gibbs proposal for variable <span class="math notranslate nohighlight">\(j\)</span> then just assembles the separator <span class="math notranslate nohighlight">\(X_j\)</span> and samples from the conditional like so:</p>
<div class="math notranslate nohighlight">
\[
s_j = R_j^{-1} [d - S X_j + u] = \mu(X_j) + R_j^{-1} u
\]</div>
<p>where <span class="math notranslate nohighlight">\(\mu(X_j) = R_j^{-1} [d - S X_j]\)</span> is the conditional mean and <span class="math notranslate nohighlight">\(u\)</span> is drawn from a standard zero-mean Gaussian with identity covariance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">proposal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Propose via Gibbs sampling&quot;&quot;&quot;</span>
    <span class="c1"># Get Conditional for x_j, computed above</span>
    <span class="n">conditional</span> <span class="o">=</span> <span class="n">conditionals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
    <span class="c1"># sample x_j and propose a new sample</span>
    <span class="n">rhs</span> <span class="o">=</span> <span class="n">conditional</span><span class="o">.</span><span class="n">d</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">parents</span> <span class="o">=</span> <span class="n">conditional</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">rhs</span> <span class="o">=</span> <span class="n">rhs</span> <span class="o">-</span> <span class="n">conditional</span><span class="o">.</span><span class="n">S</span><span class="p">()</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">])</span>
    <span class="c1"># sample from conditional Gaussian</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">gtsam</span><span class="o">.</span><span class="n">VectorValues</span><span class="p">()</span>
    <span class="n">sample</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">invR</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">@</span> <span class="p">(</span><span class="n">rhs</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">()))</span>
    <span class="n">new_x</span> <span class="o">=</span> <span class="n">gtsam</span><span class="o">.</span><span class="n">VectorValues</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">new_x</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_x</span>
</pre></div>
</div>
</div>
</div>
<p>We also create a hook to keep sufficient statistics:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">global</span> <span class="n">count</span><span class="p">,</span> <span class="nb">sum</span><span class="p">,</span> <span class="n">sum_squares</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nb">sum</span> <span class="o">=</span> <span class="n">gtsam</span><span class="o">.</span><span class="n">VectorValues</span><span class="o">.</span><span class="n">Zero</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span>
<span class="n">sum_squares</span> <span class="o">=</span> <span class="n">gtsam</span><span class="o">.</span><span class="n">VectorValues</span><span class="o">.</span><span class="n">Zero</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">save_stats</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">count</span><span class="p">,</span> <span class="nb">sum</span><span class="p">,</span> <span class="n">sum_squares</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">sum_squares</span> <span class="o">=</span> <span class="n">sum_squares</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">square</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>The Gibbs sampler is then <em>exceedingly simple</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># run Gibbs sampler</span>
<span class="n">nr_iterations</span> <span class="o">=</span> <span class="n">M</span><span class="o">*</span><span class="n">N</span><span class="o">*</span><span class="mi">5000</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">gtsam</span><span class="o">.</span><span class="n">VectorValues</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span>
<span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_iterations</span><span class="p">):</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">key_list</span><span class="p">[</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">N</span><span class="p">)]</span> <span class="c1"># choose a variable to perturb</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">proposal</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">it</span> <span class="o">&gt;=</span> <span class="n">nr_iterations</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span> <span class="n">save_stats</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Because we kept the sufficient statistics <code class="docutils literal notranslate"><span class="pre">count</span></code>, <code class="docutils literal notranslate"><span class="pre">sum</span></code>, and <code class="docutils literal notranslate"><span class="pre">sum_squares</span></code> we can compute the marginals:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gibbs_mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">count</span><span class="p">)</span>
<span class="n">avg_deviation</span> <span class="o">=</span> <span class="n">sum_squares</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">count</span><span class="p">)</span>
<span class="n">variance</span> <span class="o">=</span> <span class="n">avg_deviation</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">square</span><span class="p">(</span><span class="n">gibbs_mean</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Marginals computed from </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> correlated samples:&quot;</span><span class="p">)</span>
<span class="n">gibbs_stddev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">M</span><span class="o">*</span><span class="n">N</span><span class="p">,))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">key_list</span><span class="p">):</span>
    <span class="n">gibbs_stddev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gtsam</span><span class="o">.</span><span class="n">DefaultKeyFormatter</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">gibbs_mean</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">gibbs_stddev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The error at the mean is </span><span class="si">{</span><span class="n">graph</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">gibbs_mean</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Marginals computed from 30000 correlated samples:
a1 -0.14 +/- 0.33
a2 -0.21 +/- 0.29
a3 0.11 +/- 0.29
a4 0.20 +/- 0.33
b1 -0.40 +/- 0.30
b2 -0.29 +/- 0.25
b3 0.02 +/- 0.26
b4 0.05 +/- 0.30
c1 -0.22 +/- 0.33
c2 -0.20 +/- 0.30
c3 0.11 +/- 0.29
c4 0.17 +/- 0.34
The error at the mean is 3.150451230285521.
</pre></div>
</div>
</div>
</div>
<p>Comparing these with the direct solver solution above you can see that the mean converges, <em>as well as the standard deviations</em>. We also show this graphically below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">gibbs_mean</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">)),</span> <span class="n">zmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">exact_mean</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">)),</span> <span class="n">zmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">gibbs_stddev</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">)),</span> <span class="n">zmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="mf">0.35</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">exact_stddev</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">)),</span> <span class="n">zmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="mf">0.35</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/GaussianMRFExample_lbp_36_0.png" src="_images/GaussianMRFExample_lbp_36_0.png" />
</div>
</div>
</div>
<div class="section" id="elimination-vs-message-passing">
<h2><span class="section-number">1.4.4. </span>Elimination vs. Message Passing<a class="headerlink" href="#elimination-vs-message-passing" title="Permalink to this headline">¶</a></h2>
<p>Above we implemented LBP with elimination, where the root of the eliminated graph becomes the new belief <span class="math notranslate nohighlight">\(q_j(x_j)\)</span>. The duality with Gibbs sampling is clear, and it is very natural if you are familiar with the elimination on factor graphs.</p>
<p>However, LBP is traditionally explained/implemented with a more complex “message passing” algorithm, with two different types of messages (variable to factor, and factor to variable). Are they in fact the same? Using the small example for the top-left pixel below we will show that they are indeed.</p>
<p>Below we show the Markov blanket for <span class="math notranslate nohighlight">\(a1\)</span>, which has three factors. Let us name the unary factor <span class="math notranslate nohighlight">\(f_{a1}\)</span>, and the binary factors <span class="math notranslate nohighlight">\(f_{a2}\)</span> and <span class="math notranslate nohighlight">\(f_{b1}\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show</span><span class="p">(</span><span class="n">markov_blankets</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">binary_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hints</span><span class="o">=</span><span class="n">position_hints</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/GaussianMRFExample_lbp_38_0.svg" src="_images/GaussianMRFExample_lbp_38_0.svg" /></div>
</div>
<p>On <a class="reference external" href="https://gaussianbp.github.io/">this very cool tutorial from Imperial college</a> the more traditional view is explained beautifully. Three messages would be sent to <span class="math notranslate nohighlight">\(a1\)</span> from the three factors:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
m_{f_{a1}\rightarrow a1}(a1) &amp;= \phi(a1) \\ 
m_{f_{a2}\rightarrow a1}(a1) &amp;= \int_{a2} \phi(a1, a2) m_{a2\rightarrow f_{a2}} (a2) \\
m_{f_{b1}\rightarrow a1}(a1) &amp;= \int_{b1} \phi(a1, b1) m_{b1\rightarrow f_{b1}} (b1)
\end{align*}
\end{split}\]</div>
<p>which are then combined in the belief update</p>
<div class="math notranslate nohighlight">
\[
q(a1) \leftarrow m_{f_{a2}\rightarrow a1} (a1)~
m_{f_{b1}\rightarrow a1} (a1)~
m_{f_{a1}\rightarrow a1} (a1)
\]</div>
<p>The variable to factor messages <span class="math notranslate nohighlight">\(m_{x\rightarrow f} (x)\)</span> are calculated as the beliefs, down-dated by the last message <span class="math notranslate nohighlight">\(m_{f\rightarrow x} (x)\)</span> from <span class="math notranslate nohighlight">\(f\)</span> to <span class="math notranslate nohighlight">\(x\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
m_{a2\rightarrow f_{a2}} (a2) &amp;= \frac{q(a2)}{m_{f_{a2}\rightarrow a2} (a2)} \\
m_{b1\rightarrow f_{b1}} (b1) &amp;= \frac{q(b1)}{m_{f_{b1}\rightarrow b1} (b1)}.
\end{align*}
\end{split}\]</div>
<p>This is slightly different from the traditional exposition, but equivalent. Hence the final belief update is</p>
<div class="math notranslate nohighlight">
\[
q(a1) \leftarrow 
\phi(a1)
\{\int_{a2} \phi(a1, a2) \frac{q(a2)}{m_{f_{a2}\rightarrow a2} (a2)}\}
\{\int_{b1} \phi(a1, b1) \frac{q(b1)}{m_{f_{b1}\rightarrow b1} (b1)}\}
\]</div>
<p>LBP implemented by elimination yields obtains a new belief for <span class="math notranslate nohighlight">\(a1\)</span> by factorizing the Markov blanket, augmented with <em>downdated</em> beliefs <span class="math notranslate nohighlight">\(\frac{q(a2)}{m_{f_{a2}\rightarrow a2} (a2)}\)</span> and <span class="math notranslate nohighlight">\(\frac{q(b1)}{m_{f_{b1}\rightarrow b1} (b1)}\)</span>:</p>
<div class="math notranslate nohighlight">
\[
\phi(a1) \{\phi(a1, a2)\frac{q(a2)}{m_{f_{a2}\rightarrow a2} (a2)}\} \{\phi(a1,b1)\frac{q(b1)}{m_{f_{b1}\rightarrow b1} (b1)}\} \propto q(a1) P(a2 | a1) P(b1 | a1),
\]</div>
<p>where <span class="math notranslate nohighlight">\(q(a1)\)</span> is obtained by marginalizing out <span class="math notranslate nohighlight">\(a2\)</span> and <span class="math notranslate nohighlight">\(b1\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
q(a1) &amp;= \int_{a2, b1} \phi(a1) \{\phi(a1, a2)\frac{q(a2)}{m_{f_{a2}\rightarrow a2} (a2)}\} \{\phi(a1,b1)\frac{q(b1)}{m_{f_{b1}\rightarrow b1} (b1)}\} \\
&amp;= \phi(a1) \{\int_{a2} \phi(a1, a2)\frac{q(a2)}{m_{f_{a2}\rightarrow a2} (a2)}\} \{\int_{b1} \phi(a1,b1)\frac{q(b1)}{m_{f_{b1}\rightarrow b1} (b1)}\}.
\end{align*}
\end{split}\]</div>
<p>This is exactly the same.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="GaussianMRFExample.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">1.3. </span>Gaussian Markov Random Fields</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="GaussianMRFExample_cbp.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">1.5. </span>Clustered Belief Propagation</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Frank Dellaert and the GTSAM Community<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>